var __makeTemplateObject=this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e},__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,n,s,i){return new(s=s||Promise)(function(t,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i.throw(e))}catch(e){r(e)}}function step(e){e.done?t(e.value):function adopt(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})},__generator=this&&this.__generator||function(r,n){var s,i,c,a={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=verb(0),o.throw=verb(1),o.return=verb(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(t){return function(e){return function step(t){if(s)throw new TypeError("Generator is already executing.");for(;o&&t[o=0]&&(a=0),a;)try{if(s=1,i&&(c=2&t[0]?i.return:t[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,t[1])).done)return c;switch(i=0,(t=c?[2&t[0],c.value]:t)[0]){case 0:case 1:c=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(c=0<(c=a.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3]))a.label=t[1];else if(6===t[0]&&a.label<c[1])a.label=c[1],c=t;else{if(!(c&&a.label<c[2])){c[2]&&a.ops.pop(),a.trys.pop();continue}a.label=c[2],a.ops.push(t)}}t=n.call(r,a)}catch(e){t=[6,e],i=0}finally{s=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};import{readdir,unlink,readFile,writeFile,mkdir,mkdtemp}from"node:fs/promises";import{existsSync,readFileSync}from"node:fs";import{dirname,extname,join}from"node:path";import ts from"typescript";import{minify}from"uglify-js";import $ from"dax-sh";var cleanDir=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,readdir(r)];case 1:return t=e.sent(),[4,Promise.all(t.map(function(e){return unlink(join(r,e))}))];case 2:return e.sent(),[2]}})})},mergeFiles=function(e){return __awaiter(this,arguments,void 0,function(e){var t,r,n,s,i,c,a,o,u,l,m=e.outFilePath,f=e.indexFile,p=e.otherFiles;return __generator(this,function(e){switch(e.label){case 0:return t=dirname(m),existsSync(t)?[3,2]:[4,mkdir(t)];case 1:e.sent(),e.label=2;case 2:return[4,readFile(f.path,"utf8")];case 3:if(t=e.sent(),r=f.lines?t.split("\n").slice(f.lines).join("\n"):t,!p)return[3,8];s=[],i=0,c=p,e.label=4;case 4:return i<c.length?(a=c[i],l=null!=(l=a.removeExport)&&l,[4,readFile(a.path,"utf8")]):[3,7];case 5:u=e.sent(),u=a.lines?u.split("\n").slice(a.lines).join("\n"):u,o=u.replace(/export\s+/g,"").split("\n"),o=l?o.join("\n"):u,s.push(o),e.label=6;case 6:return i++,[3,4];case 7:return n=s.join("\n"),[3,9];case 8:n="",e.label=9;case 9:return u="\n        ".concat(n,"\n        ").concat(r,"\n        "),[4,writeFile(m,u.trim())];case 10:return e.sent(),[2]}})})},getType=function(){var e=join(process.cwd(),"package.json"),e=readFileSync(e,"utf8"),e=JSON.parse(e);return e.type&&"commonjs"!==e.type?"module":"commonjs"};function extensionReplaceEsm(e){if("commonjs"===getType()){var t=extname(e);if(".ts"===t)return e.slice(0,-3)+".mts";if(".js"===t)return e.slice(0,-3)+".mjs"}return e}function extensionReplaceCjs(e){if("module"===getType()){var t=extname(e);if(".ts"===t)return e.slice(0,-3)+".cts";if(".js"===t)return e.slice(0,-3)+".cjs"}return e}var templateObject_1,compile=function(e){return __awaiter(this,arguments,void 0,function(e){var t,r,n,s=e.fileNames,i=e.outDir,c=e.declareDir,a=e.format,o=e.replaceFunction,u=e.complierOptions;return __generator(this,function(e){switch(e.label){case 0:return t=ts.ModuleKind.ES2015,"esm"===a?t=ts.ModuleKind.ESNext:"cjs"===a?t=ts.ModuleKind.CommonJS:"browser"===a&&(t=ts.ModuleKind.ES2015),t=__assign({allowJs:!0,module:t,declaration:!0,outDir:i,declarationDir:c},u),r={},(n=ts.createCompilerHost(t)).writeFile=function(e,t){e=o?o(e):e;r[e]=t},ts.createProgram(s,t,n).emit(),[4,Promise.all(Object.entries(r).map(function(e){var t=e[0];return writeFile(t,e[1])}))];case 1:return e.sent(),[2]}})})},build=function(e){return __awaiter(this,arguments,void 0,function(e){var t,s,i,c,r,n,a,o,u,l,m,f,p,d,b,_,h,w,j=this,v=e.format,y=e.outputDirs,g=e.indexFile,F=e.otherFiles,e=e.fileName,x=void 0===e?"index.ts":e;return __generator(this,function(e){switch(e.label){case 0:return[4,mkdtemp("_bc")];case 1:return t=e.sent(),s="".concat(t,"/esm"),i="".concat(t,"/cjs"),c="".concat(t,"/bw"),r=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return v.includes("esm")?[4,mkdir(s)]:[3,2];case 1:e.sent(),e.label=2;case 2:return v.includes("cjs")?[4,mkdir(i)]:[3,4];case 3:e.sent(),e.label=4;case 4:return v.includes("browser")?[4,mkdir(c)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2]}})})},n=v.includes("esm"),a=v.includes("cjs"),o=v.includes("browser"),h=v.includes("esm")&&v.includes("cjs")&&v.includes("browser")&&y.esm===y.cjs&&y.esm===y.browser,u=v.includes("esm")&&v.includes("cjs")&&y.esm===y.cjs,l=v.includes("esm")&&v.includes("browser")&&y.esm===y.browser,m=v.includes("cjs")&&v.includes("browser")&&!v.includes("esm")&&y.cjs===y.browser,f=h||u||l||!m&&n,p=m||!n&&!o&&a,d=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return existsSync(y.esm)?(cleanDir(y.esm),[3,3]):[3,1];case 1:return[4,mkdir(y.esm)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},b=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return existsSync(y.cjs)?(cleanDir(y.cjs),[3,3]):[3,1];case 1:return[4,mkdir(y.cjs)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},_=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return existsSync(y.browser)?(cleanDir(y.browser),[3,3]):[3,1];case 1:return[4,mkdir(y.browser)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},h=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return f?[4,d()]:[3,2];case 1:return e.sent(),[3,6];case 2:return p?[4,b()]:[3,4];case 3:return e.sent(),[3,6];case 4:return[4,_()];case 5:e.sent(),e.label=6;case 6:return[2]}})})},w="".concat(t,"/").concat(x),[4,mergeFiles({outFilePath:w,indexFile:g,otherFiles:F})];case 2:return e.sent(),[4,$.sleep(500)];case 3:return e.sent(),[4,r()];case 4:return e.sent(),[4,$.sleep(500)];case 5:return e.sent(),[4,h()];case 6:return e.sent(),[4,$.sleep(1e3)];case 7:return(e.sent(),v.includes("esm"))?[4,function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,compile({fileNames:[w],format:"esm",declareDir:y.esm,outDir:s,replaceFunction:extensionReplaceEsm})];case 1:return e.sent(),[4,$.sleep(3e3)];case 2:return e.sent(),[4,readdir(s)];case 3:return t=e.sent(),[4,readFile("".concat(s,"/").concat(t),"utf8")];case 4:return r=e.sent(),r=minify(r,{sourceMap:!0,keep_fnames:!0}),n="\n      ".concat(r.code,"\n      //# sourceMappingURL=").concat(t,".map\n      "),[4,writeFile("".concat(y.esm,"/").concat(t),n.trim())];case 5:return(e.sent(),r.map)?[4,writeFile("".concat(y.esm,"/").concat(t,".map"),r.map)]:[3,7];case 6:e.sent(),e.label=7;case 7:return[2]}})})}()]:[3,9];case 8:e.sent(),e.label=9;case 9:return[4,$.sleep(1e3)];case 10:return(e.sent(),v.includes("cjs"))?[4,function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,compile({fileNames:[w],format:"cjs",declareDir:y.esm,outDir:i,replaceFunction:extensionReplaceCjs})];case 1:return e.sent(),[4,readdir(i)];case 2:return t=e.sent(),[4,readFile("".concat(i,"/").concat(t),"utf8")];case 3:return r=e.sent(),r=minify(r,{sourceMap:!0,keep_fnames:!0}),n="\n      ".concat(r.code,"\n      //# sourceMappingURL=").concat(t,".map\n      "),[4,writeFile("".concat(y.cjs,"/").concat(t),n.trim())];case 4:return(e.sent(),r.map)?[4,writeFile("".concat(y.cjs,"/").concat(t,".map"),r.map)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2]}})})}()]:[3,12];case 11:e.sent(),e.label=12;case 12:return[4,$.sleep(1e3)];case 13:return(e.sent(),v.includes("browser"))?[4,function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,compile({fileNames:[w],format:"browser",declareDir:y.esm,outDir:c})];case 1:return e.sent(),[4,readdir(c)];case 2:return t=e.sent(),[4,readFile("".concat(c,"/").concat(t),"utf8")];case 3:return r=e.sent(),r=r.replace(/export\s+/g,"").split("\n"),r=r.join("\n"),r=minify(r,{sourceMap:!0,keep_fnames:!0}),n="\n      ".concat(r.code,"\n      //# sourceMappingURL=").concat(t,".map\n      "),[4,writeFile("".concat(y.browser,"/").concat(t),n.trim())];case 4:return(e.sent(),r.map)?[4,writeFile("".concat(y.browser,"/").concat(t,".map"),r.map)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2]}})})}()]:[3,15];case 14:e.sent(),e.label=15;case 15:return[4,$.sleep(3e3)];case 16:return e.sent(),[4,$(templateObject_1=templateObject_1||__makeTemplateObject(["rm -r ",""],["rm -r ",""]),t)];case 17:return e.sent(),[2]}})})};export{cleanDir,compile,build,minify};