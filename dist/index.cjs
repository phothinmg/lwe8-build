var __makeTemplateObject=this&&this.__makeTemplateObject||function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e},__assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,n,s,i){return new(s=s||Promise)(function(t,r){function fulfilled(e){try{step(i.next(e))}catch(e){r(e)}}function rejected(e){try{step(i.throw(e))}catch(e){r(e)}}function step(e){e.done?t(e.value):function adopt(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(fulfilled,rejected)}step((i=i.apply(e,n||[])).next())})},__generator=this&&this.__generator||function(r,n){var s,i,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=verb(0),o.throw=verb(1),o.return=verb(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function verb(t){return function(e){return function step(t){if(s)throw new TypeError("Generator is already executing.");for(;o&&t[o=0]&&(c=0),c;)try{if(s=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,(t=a?[2&t[0],a.value]:t)[0]){case 0:case 1:a=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,i=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3]))c.label=t[1];else if(6===t[0]&&c.label<a[1])c.label=a[1],a=t;else{if(!(a&&c.label<a[2])){a[2]&&c.ops.pop(),c.trys.pop();continue}c.label=a[2],c.ops.push(t)}}t=n.call(r,c)}catch(e){t=[6,e],i=0}finally{s=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},promises_1=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.minify=exports.build=exports.compile=exports.cleanDir=void 0,require("node:fs/promises")),node_fs_1=require("node:fs"),node_path_1=require("node:path"),typescript_1=require("typescript"),uglify_js_1=require("uglify-js"),dax_sh_1=(Object.defineProperty(exports,"minify",{enumerable:!0,get:function(){return uglify_js_1.minify}}),require("dax-sh")),cleanDir=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,(0,promises_1.readdir)(r)];case 1:return t=e.sent(),[4,Promise.all(t.map(function(e){return(0,promises_1.unlink)((0,node_path_1.join)(r,e))}))];case 2:return e.sent(),[2]}})})},mergeFiles=(exports.cleanDir=cleanDir,function(e){return __awaiter(this,arguments,void 0,function(e){var t,r,n,s,i,a,c,o,u,l,p=e.outFilePath,_=e.indexFile,d=e.otherFiles;return __generator(this,function(e){switch(e.label){case 0:return t=(0,node_path_1.dirname)(p),(0,node_fs_1.existsSync)(t)?[3,2]:[4,(0,promises_1.mkdir)(t)];case 1:e.sent(),e.label=2;case 2:return[4,(0,promises_1.readFile)(_.path,"utf8")];case 3:if(t=e.sent(),r=_.lines?t.split("\n").slice(_.lines).join("\n"):t,!d)return[3,8];s=[],i=0,a=d,e.label=4;case 4:return i<a.length?(c=a[i],l=null!=(l=c.removeExport)&&l,[4,(0,promises_1.readFile)(c.path,"utf8")]):[3,7];case 5:u=e.sent(),u=c.lines?u.split("\n").slice(c.lines).join("\n"):u,o=u.replace(/export\s+/g,"").split("\n"),o=l?o.join("\n"):u,s.push(o),e.label=6;case 6:return i++,[3,4];case 7:return n=s.join("\n"),[3,9];case 8:n="",e.label=9;case 9:return u="\n        ".concat(n,"\n        ").concat(r,"\n        "),[4,(0,promises_1.writeFile)(p,u.trim())];case 10:return e.sent(),[2]}})})}),getType=function(){var e=(0,node_path_1.join)(process.cwd(),"package.json"),e=(0,node_fs_1.readFileSync)(e,"utf8"),e=JSON.parse(e);return e.type&&"commonjs"!==e.type?"module":"commonjs"};function extensionReplaceEsm(e){if("commonjs"===getType()){var t=(0,node_path_1.extname)(e);if(".ts"===t)return e.slice(0,-3)+".mts";if(".js"===t)return e.slice(0,-3)+".mjs"}return e}function extensionReplaceCjs(e){if("module"===getType()){var t=(0,node_path_1.extname)(e);if(".ts"===t)return e.slice(0,-3)+".cts";if(".js"===t)return e.slice(0,-3)+".cjs"}return e}var templateObject_1,compile=function(e){return __awaiter(this,arguments,void 0,function(e){var t,r,n,s=e.fileNames,i=e.outDir,a=e.declareDir,c=e.format,o=e.replaceFunction,u=e.complierOptions;return __generator(this,function(e){switch(e.label){case 0:return t=typescript_1.default.ModuleKind.ES2015,"esm"===c?t=typescript_1.default.ModuleKind.ESNext:"cjs"===c?t=typescript_1.default.ModuleKind.CommonJS:"browser"===c&&(t=typescript_1.default.ModuleKind.ES2015),t=__assign({allowJs:!0,module:t,declaration:!0,outDir:i,declarationDir:a},u),r={},(n=typescript_1.default.createCompilerHost(t)).writeFile=function(e,t){e=o?o(e):e;r[e]=t},typescript_1.default.createProgram(s,t,n).emit(),[4,Promise.all(Object.entries(r).map(function(e){var t=e[0];return(0,promises_1.writeFile)(t,e[1])}))];case 1:return e.sent(),[2]}})})},build=(exports.compile=compile,function(e){return __awaiter(this,arguments,void 0,function(e){var t,s,i,a,r,n,c,o,u,l,p,_,d,f,m,h,b,w,j=this,y=e.format,v=e.outputDirs,x=e.indexFile,g=e.otherFiles,e=e.fileName,F=void 0===e?"index.ts":e;return __generator(this,function(e){switch(e.label){case 0:return[4,(0,promises_1.mkdtemp)("_bc")];case 1:return t=e.sent(),s="".concat(t,"/esm"),i="".concat(t,"/cjs"),a="".concat(t,"/bw"),r=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return y.includes("esm")?[4,(0,promises_1.mkdir)(s)]:[3,2];case 1:e.sent(),e.label=2;case 2:return y.includes("cjs")?[4,(0,promises_1.mkdir)(i)]:[3,4];case 3:e.sent(),e.label=4;case 4:return y.includes("browser")?[4,(0,promises_1.mkdir)(a)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2]}})})},n=y.includes("esm"),c=y.includes("cjs"),o=y.includes("browser"),b=y.includes("esm")&&y.includes("cjs")&&y.includes("browser")&&v.esm===v.cjs&&v.esm===v.browser,u=y.includes("esm")&&y.includes("cjs")&&v.esm===v.cjs,l=y.includes("esm")&&y.includes("browser")&&v.esm===v.browser,p=y.includes("cjs")&&y.includes("browser")&&!y.includes("esm")&&v.cjs===v.browser,_=b||u||l||!p&&n,d=p||!n&&!o&&c,f=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return(0,node_fs_1.existsSync)(v.esm)?((0,exports.cleanDir)(v.esm),[3,3]):[3,1];case 1:return[4,(0,promises_1.mkdir)(v.esm)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},m=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return(0,node_fs_1.existsSync)(v.cjs)?((0,exports.cleanDir)(v.cjs),[3,3]):[3,1];case 1:return[4,(0,promises_1.mkdir)(v.cjs)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},h=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return(0,node_fs_1.existsSync)(v.browser)?((0,exports.cleanDir)(v.browser),[3,3]):[3,1];case 1:return[4,(0,promises_1.mkdir)(v.browser)];case 2:e.sent(),e.label=3;case 3:return[2]}})})},b=function(){return __awaiter(j,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return _?[4,f()]:[3,2];case 1:return e.sent(),[3,6];case 2:return d?[4,m()]:[3,4];case 3:return e.sent(),[3,6];case 4:return[4,h()];case 5:e.sent(),e.label=6;case 6:return[2]}})})},w="".concat(t,"/").concat(F),[4,mergeFiles({outFilePath:w,indexFile:x,otherFiles:g})];case 2:return e.sent(),[4,dax_sh_1.default.sleep(500)];case 3:return e.sent(),[4,r()];case 4:return e.sent(),[4,dax_sh_1.default.sleep(500)];case 5:return e.sent(),[4,b()];case 6:return e.sent(),[4,dax_sh_1.default.sleep(1e3)];case 7:return(e.sent(),y.includes("esm"))?[4,function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,(0,exports.compile)({fileNames:[w],format:"esm",declareDir:v.esm,outDir:s,replaceFunction:extensionReplaceEsm})];case 1:return e.sent(),[4,dax_sh_1.default.sleep(3e3)];case 2:return e.sent(),[4,(0,promises_1.readdir)(s)];case 3:return t=e.sent(),[4,(0,promises_1.readFile)("".concat(s,"/").concat(t),"utf8")];case 4:return r=e.sent(),r=(0,uglify_js_1.minify)(r,{sourceMap:!0,keep_fnames:!0}),n="\n      ".concat(r.code,"\n      //# sourceMappingURL=").concat(t,".map\n      "),[4,(0,promises_1.writeFile)("".concat(v.esm,"/").concat(t),n.trim())];case 5:return(e.sent(),r.map)?[4,(0,promises_1.writeFile)("".concat(v.esm,"/").concat(t,".map"),r.map)]:[3,7];case 6:e.sent(),e.label=7;case 7:return[2]}})})}()]:[3,9];case 8:e.sent(),e.label=9;case 9:return[4,dax_sh_1.default.sleep(1e3)];case 10:return(e.sent(),y.includes("cjs"))?[4,function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,(0,exports.compile)({fileNames:[w],format:"cjs",declareDir:v.esm,outDir:i,replaceFunction:extensionReplaceCjs})];case 1:return e.sent(),[4,(0,promises_1.readdir)(i)];case 2:return t=e.sent(),[4,(0,promises_1.readFile)("".concat(i,"/").concat(t),"utf8")];case 3:return r=e.sent(),r=(0,uglify_js_1.minify)(r,{sourceMap:!0,keep_fnames:!0}),n="\n      ".concat(r.code,"\n      //# sourceMappingURL=").concat(t,".map\n      "),[4,(0,promises_1.writeFile)("".concat(v.cjs,"/").concat(t),n.trim())];case 4:return(e.sent(),r.map)?[4,(0,promises_1.writeFile)("".concat(v.cjs,"/").concat(t,".map"),r.map)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2]}})})}()]:[3,12];case 11:e.sent(),e.label=12;case 12:return[4,dax_sh_1.default.sleep(1e3)];case 13:return(e.sent(),y.includes("browser"))?[4,function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,(0,exports.compile)({fileNames:[w],format:"browser",declareDir:v.esm,outDir:a})];case 1:return e.sent(),[4,(0,promises_1.readdir)(a)];case 2:return t=e.sent(),[4,(0,promises_1.readFile)("".concat(a,"/").concat(t),"utf8")];case 3:return r=e.sent(),r=r.replace(/export\s+/g,"").split("\n"),r=r.join("\n"),r=(0,uglify_js_1.minify)(r,{sourceMap:!0,keep_fnames:!0}),n="\n      ".concat(r.code,"\n      //# sourceMappingURL=").concat(t,".map\n      "),[4,(0,promises_1.writeFile)("".concat(v.browser,"/").concat(t),n.trim())];case 4:return(e.sent(),r.map)?[4,(0,promises_1.writeFile)("".concat(v.browser,"/").concat(t,".map"),r.map)]:[3,6];case 5:e.sent(),e.label=6;case 6:return[2]}})})}()]:[3,15];case 14:e.sent(),e.label=15;case 15:return[4,dax_sh_1.default.sleep(3e3)];case 16:return e.sent(),[4,(0,dax_sh_1.default)(templateObject_1=templateObject_1||__makeTemplateObject(["rm -r ",""],["rm -r ",""]),t)];case 17:return e.sent(),[2]}})})});exports.build=build;